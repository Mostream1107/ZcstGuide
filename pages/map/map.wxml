<!--pages/map/map.wxml-->
<view class="card">
  <view class="card-top">
    <view class="card-top-left" style="width: calc(100vw - 130px);">
      <view class="card-top-left-view up">
        <view class="card-top-circle start"></view>
        <input class="card-top-input" value="{{start.name}}" placeholder="å½“å‰åœ°ç‚¹/èµ·ç‚¹" disabled="true" data-search_id="{{1}}" bindtap="tosearch" />
      </view>

      <view class="card-top-left-view">
        <view class="card-top-circle end"></view>
        <input class="card-top-input" value="{{end.name}}" placeholder="è¯·é€‰æ‹©ç»ˆç‚¹" disabled="true" data-search_id="{{w}}" bindtap="tosearch" />
      </view>
    </view>

    <view class="card-top-middle">
      <image src="{{exchange}}" mode="" class="card-top-middle-button" bindtap="exchange" />

      <!-- <view class="card-top-middle-button" style="font-size: larger;" bindtap="exchange">â‡µ</view> -->
    </view>

    <view class="card-top-right">
      <view class="card-top-right-button" bindtap="formSubmit">
        è·¯çº¿
      </view>
    </view>
  </view>
</view>

<view class="relative">
  <scroll-view scroll-x="true" scroll-left="{{scrollLeft}}" scroll-with-animation="true">
    <view class="card-bottom-category" style="width: {{site_data.length*75}}px;">
      <view class="card-bottom-category-label {{index == category ? 'choose' : ''}}" wx:for="{{site_data}}" wx:key="id" id="{{index}}" bindtap="changeCategory">
        {{item.name}}
      </view>
    </view>
  </scroll-view>
</view>

<map style="width: 100%; height: calc(100% - 180px);" id="map"latitude="{{latitude}}" longitude="{{longitude}}" scale="{{scale}}" min-scale="{{minscale}}" show-location="{{showLocation}}" enable-poi="{{enablepoi}}" markers="{{markers}}" include-points="" polyline="{{polyline}}" polygons="{{polygons}}" bindmarkertap="markertap">

  <!-- å³ä¾§æŒ‰é’®åŒºåŸŸï¼Œå‚ç›´æ’åˆ— -->
  <view class="map_right_card" style="margin-top: calc(100vh - 440px);">

    <!-- è¿˜åŸæŒ‰é’® -->
    <view class="location">
      <view wx:if="{{polyline.length != 0}}" class="instruction" bindtap="restore">
        <image class="img" src="{{restore}}" bindtap="restore" />
      </view>
    </view>

    <!-- å®šä½æŒ‰é’® -->
    <view class="location">
      <view class="instruction">
        <image class="img" src="{{location}}" bindtap="location" />
      </view>
    </view>
    
    <!-- ä½¿ç”¨è¯´æ˜æŒ‰é’® -->
    <view class="location">
      <view class="instruction">
        <image class="img" src="{{use}}" bindtap="toinstruction" />
      </view>
    </view>

    <!-- å†å²è®°å½•æŒ‰é’® -->
    <view class="location">
      <view class="instruction" bindtap="showHistory">
        <text class="history-icon">ğŸ“‹</text>
      </view>
    </view>

  </view>

  <view class="map_right_card" style="margin-top: calc(100vh - 245px);width: 100%;">
    <view class="duration_and_distance" style="width: 100%;">
      <view class="duration_and_distance_style">
        <view wx:if="{{polyline.length != 0}}" class="duration_and_distance_text">è€—æ—¶ï¼š{{duration}}åˆ†é’Ÿ è·ç¦»ï¼š{{distance}}ç±³</view>
      </view>
    </view>
  </view>
</map>

<view class="card-bottom">
  <view class="card-bottom-button" bindtap="clickButton">
    <view wx:if="{{polyline.length == 0}}">
      ğŸ« {{site_data[category].name}} æœ‰ {{site_data[category].list.length}} ä¸ªåœ°ç‚¹
    </view>
    <view wx:if="{{polyline.length != 0}}">
      ğŸ§­ è·¯çº¿è¯¦æƒ…
    </view>
  </view>
  
</view>

<mp-dialog title="{{card.name}}" show="{{dialogShow_site}}" bindbuttontap="mapmarker_choose" buttons="{{buttons}}">
  <view>
    <image bindtap="lookPhoto" mode="heightFix" style="height:270rpx;" src="{{card.img}}" data-src="{{card.img}}"></image>

    <view style="font-size:90%">{{card.aliases}}</view>

    <view>{{card.desc}}</view>
  </view>
</mp-dialog>

<mp-dialog title="{{site_data[category].name}}" show="{{dialogShow_category}}" bindbuttontap="mapmarker_close" buttons="{{button}}">
  <view wx:for="{{site_data[category].list}}" wx:key="id">
    <view>{{index+1}}.{{item.name}}</view>
  </view>
</mp-dialog>

<mp-dialog title="è·¯çº¿è¯¦æƒ…" show="{{dialogShow_road}}" bindbuttontap="mapmarker_close" buttons="{{button}}">
  <view class="road r_duration_and_distance">è€—æ—¶ï¼š{{duration}}åˆ†é’Ÿ è·ç¦»ï¼š{{distance}}ç±³</view>

  <view class="road road_start">èµ·ç‚¹ï¼š{{start.name}}</view>

  <view wx:for="{{steps}}" wx:key="id">
    <view class="road">{{index+1}}.{{item.instruction}}</view>
  </view>

  <view class="road road_end">ç»ˆç‚¹ï¼š{{end.name}}</view>
</mp-dialog>

<!-- å†å²è®°å½•å¯¹è¯æ¡† -->
<mp-dialog title="å†å²æµè§ˆè®°å½•" show="{{dialogShow_history}}" bindbuttontap="handleHistoryDialog" buttons="{{historyButtons}}">
  <view class="history-tabs">
    <view class="history-tab {{activeHistoryTab === 'locations' ? 'active-tab' : ''}}" 
          bindtap="switchHistoryTab" data-tab="locations">
      åœ°ç‚¹å†å²
    </view>
    <view class="history-tab {{activeHistoryTab === 'routes' ? 'active-tab' : ''}}" 
          bindtap="switchHistoryTab" data-tab="routes">
      è·¯çº¿å†å²
    </view>
  </view>
  
  <!-- åœ°ç‚¹å†å²æ ‡ç­¾é¡µå†…å®¹ -->
  <view class="history-list" wx:if="{{activeHistoryTab === 'locations'}}">
    <view wx:if="{{historyList.length === 0}}" class="history-empty">
      æš‚æ— æµè§ˆè®°å½•
    </view>
    <view wx:for="{{historyList}}" wx:key="id" class="history-item" bindtap="selectHistoryItem" data-index="{{index}}">
      <view class="history-item-name">{{item.name}}</view>
      <view class="history-item-info">
        <text class="history-item-category" wx:if="{{item.category}}">{{item.category}}</text>
        <text class="history-item-time">{{item.timestamp ? wxs.formatTime(item.timestamp) : ''}}</text>
      </view>
    </view>
  </view>
  
  <!-- è·¯çº¿å†å²æ ‡ç­¾é¡µå†…å®¹ -->
  <view class="history-list" wx:if="{{activeHistoryTab === 'routes'}}">
    <view wx:if="{{routeHistoryList.length === 0}}" class="history-empty">
      æš‚æ— è·¯çº¿è®°å½•
    </view>
    <view wx:for="{{routeHistoryList}}" wx:key="id" class="history-item route-item" bindtap="selectRouteHistoryItem" data-index="{{index}}">
      <view class="route-item-path">
        <text class="route-point">{{item.start.name}}</text>
        <text class="route-arrow">â†’</text>
        <text class="route-point">{{item.end.name}}</text>
      </view>
      <view class="history-item-info">
        <view class="route-categories">
          <text class="history-item-category" wx:if="{{item.start.category}}">{{item.start.category}}</text>
          <text class="history-item-category" wx:if="{{item.end.category}}">{{item.end.category}}</text>
        </view>
        <text class="history-item-time">{{item.timestamp ? wxs.formatTime(item.timestamp) : ''}}</text>
      </view>
    </view>
  </view>
</mp-dialog>

<!-- WXSæ¨¡å—ç”¨äºæ ¼å¼åŒ–æ—¶é—´æˆ³ -->
<wxs module="wxs">
  function formatTime(timestamp) {
    // ç”±äºwxsä¸æ”¯æŒDateå¯¹è±¡ï¼Œåªèƒ½æ‰‹åŠ¨è®¡ç®—
    var now = getDate().getTime();
    var diff = now - timestamp;
    
    if (diff < 60000) { // å°äº1åˆ†é’Ÿ
      return "åˆšåˆš";
    } else if (diff < 3600000) { // å°äº1å°æ—¶
      return Math.floor(diff / 60000) + "åˆ†é’Ÿå‰";
    } else if (diff < 86400000) { // å°äº24å°æ—¶
      return Math.floor(diff / 3600000) + "å°æ—¶å‰";
    } else if (diff < 2592000000) { // å°äº30å¤©
      return Math.floor(diff / 86400000) + "å¤©å‰";
    } else {
      var date = getDate(timestamp);
      return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
    }
  }
  
  module.exports = {
    formatTime: formatTime
  };
</wxs>